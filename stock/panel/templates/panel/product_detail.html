{% extends 'base.html' %}
{% block title %}Product Details{% endblock %}
{% block content %}
<div class="card card-custom">
    <div class="card-header">
        <h3>Product Details</h3>
    </div>
    <div class="card-body">
        <form method="POST" action="">
            {% csrf_token %}
            <div class="mb-3 position-relative">
                <label for="product_search" class="form-label">Search or Select Product</label>
                <input type="text" class="form-control" id="product_search" name="name" placeholder="Type to search or create new" value="{{ form.name.value|default_if_none:product_name }}" autocomplete="off" required>
                <div id="product_list" class="list-group position-absolute w-100 mt-1" style="z-index: 1000; display: none;"></div>
            </div>
            <div class="mb-3">
                <label class="form-label">Reference</label>
                <p id="productReference">{{ form.reference.value|default_if_none:'' }}</p>
            </div>
            <div class="mb-3">
                <label class="form-label">User Name</label>
                <p id="productUserName">{{ form.user_name.value|default_if_none:'' }}</p>
            </div>
            <div class="mb-3">
                <label class="form-label">Abbreviated User Name</label>
                <p id="productAbbreviatedUserName">{{ form.abbreviated_user_name.value|default_if_none:'' }}</p>
            </div>
            <div class="mb-3">
                <label class="form-label">Description</label>
                <p id="productDescription">{{ form.description.value|default_if_none:'' }}</p>
            </div>
            <div class="mb-3">
                <label class="form-label">Order Link</label>
                <p id="productOrderLink">{{ form.order_link.value|default_if_none:'' }}</p>
            </div>
            <div class="mb-3">
                <label class="form-label">Stock Count</label>
                <p id="productCount">{{ count|default_if_none:0 }}</p>
            </div>
            <button type="submit" class="btn btn-custom">Update</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productSearch = document.getElementById('product_search');
        const productList = document.getElementById('product_list');

        productSearch.addEventListener('input', function() {
            const query = this.value;
            if (query.length > 0) {
                fetch(`/panel/product-search/?query=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        productList.innerHTML = '';
                        data.forEach(product => {
                            const item = document.createElement('a');
                            item.classList.add('list-group-item', 'list-group-item-action');
                            item.textContent = product.name;
                            item.href = '#';
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                productSearch.value = product.name;
                                document.getElementById('productReference').textContent = product.reference || '';
                                document.getElementById('productUserName').textContent = product.user_name || '';
                                document.getElementById('productAbbreviatedUserName').textContent = product.abbreviated_user_name || '';
                                document.getElementById('productDescription').textContent = product.description || '';
                                document.getElementById('productOrderLink').textContent = product.order_link || '';
                                document.getElementById('productCount').textContent = product.stock_count || 0;
                                productList.style.display = 'none';
                            });
                            productList.appendChild(item);
                        });
                        productList.style.display = 'block';
                    });
            } else {
                productList.style.display = 'none';
            }
        });

        document.addEventListener('click', function(e) {
            if (!productSearch.contains(e.target) && !productList.contains(e.target)) {
                productList.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}