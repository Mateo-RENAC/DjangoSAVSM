{% extends 'base.html' %}
{% block title %}{{ form.instance.pk|yesno:"Edit,Add" }} Product{% endblock %}
{% block content %}
<div class="card card-custom">
    <div class="card-header">
        <h3>{{ form.instance.pk|yesno:"Edit,Add" }} Product</h3>
    </div>
    <div class="card-body">
        <form method="POST" action="">
            {% csrf_token %}
            <div class="mb-3 position-relative">
                <label for="product_search" class="form-label">Search or Select Product</label>
                <input type="text" class="form-control" id="product_search" name="name" placeholder="Type to search or create new" value="{{ form.name.value|default_if_none:'' }}" autocomplete="off" required>
                <div id="product_list" class="list-group position-absolute w-100 mt-1" style="z-index: 1000; display: none;"></div>
            </div>
            <div class="mb-3">
                <label for="reference" class="form-label">Reference</label>
                <input type="text" class="form-control" id="reference" name="reference" value="{{ form.reference.value|default_if_none:'' }}">
            </div>
            <div class="mb-3">
                <label for="user_name" class="form-label">User Name</label>
                <input type="text" class="form-control" id="user_name" name="user_name" value="{{ form.user_name.value|default_if_none:'' }}">
            </div>
            <div class="mb-3">
                <label for="abbreviated_user_name" class="form-label">Abbreviated User Name</label>
                <input type="text" class="form-control" id="abbreviated_user_name" name="abbreviated_user_name" value="{{ form.abbreviated_user_name.value|default_if_none:'' }}">
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description">{{ form.description.value|default_if_none:'' }}</textarea>
            </div>
            <div class="mb-3">
                <label for="order_link" class="form-label">Order Link</label>
                <input type="url" class="form-control" id="order_link" name="order_link" value="{{ form.order_link.value|default_if_none:'' }}">
            </div>
            <div class="mb-3">
                <label for="count" class="form-label">Stock Count</label>
                <input type="number" class="form-control" id="count" name="count" value="{{ count|default_if_none:0 }}" required>
            </div>
            <button type="submit" class="btn btn-custom">{{ form.instance.pk|yesno:"Update,Add" }} Product</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productSearch = document.getElementById('product_search');
        const productList = document.getElementById('product_list');

        productSearch.addEventListener('input', function() {
            const query = this.value;
            if (query.length > 0) {
                fetch(`/panel/product-search/?query=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        productList.innerHTML = '';
                        data.forEach(product => {
                            const item = document.createElement('a');
                            item.classList.add('list-group-item', 'list-group-item-action');
                            item.textContent = product.name;
                            item.href = '#';
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                productSearch.value = product.name;
                                document.getElementById('reference').value = product.reference || '';
                                document.getElementById('user_name').value = product.user_name || '';
                                document.getElementById('abbreviated_user_name').value = product.abbreviated_user_name || '';
                                document.getElementById('description').value = product.description || '';
                                document.getElementById('order_link').value = product.order_link || '';
                                document.getElementById('count').value = product.stock_count || 0;
                                productList.style.display = 'none';
                            });
                            productList.appendChild(item);
                        });
                        productList.style.display = 'block';
                    });
            } else {
                productList.style.display = 'none';
            }
        });

        document.addEventListener('click', function(e) {
            if (!productSearch.contains(e.target) && !productList.contains(e.target)) {
                productList.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}